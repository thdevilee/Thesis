---
title: "KNN simulation synthetic data"
author: "Thomas Devilee"
date: "9-5-2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
library(foreach)
source("sampling_funcs.R")
```


```{r}
tmp <- matrix(rnorm(200), nrow = 20, ncol = 10)

randomsplit <- function(regs, indx, spltb_reg, nodesize, leafsize = 1){
  unq_indx <- names(spltb_reg)
  splt_indx <- rep(NA, nrow(regs))
  
  for (i in 1:length(unq_indx)){
    sub_indx <- indx == unq_indx[i]
    sub_regs <- regs[sub_indx, ]
    n_sub <- sum(as.numeric(sub_indx))
    if(n_sub < 2*leafsize | all(!spltb_reg[[unq_indx[i]]]) | n_sub < nodesize) next
    splt <- TRUE
    while(splt){
      splt_indx[sub_indx] <- 1
      rcol <- sample(seq(1,ncol(regs)), size = 1)
      if (!rcol %in% which(spltb_reg[[unq_indx[i]]])) next
      rrow <- sample(1:nrow(sub_regs), size = 1)
      ineq_vec <- parse(text = paste(sub_regs[rrow, rcol], sample(c("<", "<=", ">=", ">"), size = 1), sub_regs[, rcol]))
      cond_indx <- sapply(ineq_vec, eval)
      splt_indx[sub_indx][cond_indx] <- 2
      if (var(splt_indx[sub_indx]) != 0) splt <- FALSE
    }
  }
  return(as.character(splt_indx))
}

updatesplit <- function(regs, indx, spltb_reg, nodesize, leafsize){
  out <- indx
  updt_indx <- randomsplit(regs = regs, indx = indx, spltb_reg = spltb_reg, nodesize = nodesize, leafsize = leafsize)
  log_indx <- !is.na(updt_indx)
  out[log_indx] <- paste0(indx[log_indx], updt_indx[log_indx])
  return(out)
}

regsplits <- function(regs, indx, leafsize){
  indx_names <- unique(indx)
  out <- vector(mode = "list", length = length(indx_names))
  names(out) <- indx_names
  
  for (i in 1:length(indx_names)){
    regs_sub <- regs[(indx == indx_names[i]), ]
    tmp <- vector(mode = "list", length = ncol(regs))
    
    for (j in 1:ncol(regs)){
      cumtable <- table(regs[, j])
      tmp[[j]] <- (sum(cumtable) - max(cumtable)) >= leafsize
    }
    
    out[[indx_names[i]]] <- drop(do.call(rbind, tmp))
    
  }
  return(out)
}
regsplits(tmp, rep(c("1", "2"), 10), leafsize = 1)

gensplits <- function(regs, maxdepth = NA, maxnodes = NA, nodesize = NA, leafsize = 1){
  if (is.na(maxnodes)) maxnodes <- nrow(regs)
  if (is.na(maxdepth)) maxdepth <- nrow(regs)
  if (is.na(nodesize)) nodesize <- 2
  indx <- rep("1", nrow(regs))
  out <- t(matrix(indx))
  out <- rbind(out, out)
  
  i <- 1
  spltb_reg <- regsplits(regs, out[i, ], leafsize = leafsize)
  psbl_split <- any(unlist(spltb_reg))
  while (max(nchar(out[i, ])) - 1 < maxdepth &
         length(unique(out[i, ])) < maxnodes &
         !all(table(out[i, ]) < 2*leafsize) &
         any(table(out[i, ] >= nodesize)) &
         psbl_split
         ){
    tmp <- updatesplit(regs = regs, indx = out[i, ], spltb_reg = spltb_reg, nodesize = nodesize, leafsize = leafsize)
    
    if(max(nchar(tmp)) - 1 <= maxdepth &
       length(unique(tmp)) <= maxnodes &
       all(table(tmp) >= leafsize)){
      
      out[i + 1, ] <- tmp
      i <- i + 1
      out <- rbind(out[1:i, ], out[i, ])
      spltb_reg <- regsplits(regs, out[i, ], leafsize = leafsize)
      psbl_split <- any(unlist(spltb_reg))
    }
  }
  return(out[i, ])
}

gentrees <- function(regs, n_tree, maxdepth = NA, maxnodes = NA, nodesize = NA, leafsize = 1){
  pckgs <- as.vector(lsf.str(.GlobalEnv))
  out <- foreach(j = 1:n_tree, .combine = "cbind", .export = pckgs) %dopar% {
    splts <- gensplits(regs = regs, maxdepth = maxdepth, maxnodes = maxnodes, nodesize = nodesize, leafsize = leafsize)
    sapply(splts, FUN = function(x) as.numeric(substr(x, nchar(x), nchar(x)) == 2))
  }
  rownames(out) <- NULL
  colnames(out) <- 1:n_tree
  return(out)
}

S <- function(X, y){
  num <- sum((t(y) %*% X)^2)
  denom <- t(y)  %*% y
  return(drop(num/denom))
}


randomRF <- function(regs, labs, n_tree, n_perms, maxdepth = NA, maxnodes = NA, nodesize = NA, leafsize = 1){
  y <- as.matrix(as.numeric(labs))
  pckgs <- as.vector(lsf.str(.GlobalEnv))
  X <- gentrees(regs = regs, n_tree = n_tree, maxdepth = maxdepth, maxnodes = maxnodes, nodesize = nodesize, leafsize = leafsize)
  stat <- S(X, y)
  
  permed_stat <- foreach(j = 1:n_perms, .combine = "c", .export = pckgs) %dopar% {
    yp <- y[sample(nrow(y)), ]
    S(X, yp)
  }
  return(1 - mean(stat > permed_stat))
}
```

```{r}
StabExp <- function(n_tree, data, reps = 100, n_perms = 1000, leafsize = 5){
  labs <- data[, "y"] ### extract labels
  regs <- data[, !names(data) %in% "y"] ### extract predictors
  out <- vector(mode = "list", length = length(n_tree))
  for (i in 1:length(n_tree)){
    out[[i]] <- replicate(reps, expr = 
                             randomRF(regs = regs, labs = labs, n_tree = n_tree[i], n_perms = n_perms, leafsize = leafsize)
    )
  }
  return(out)
}
```

```{r}
n_tree <- c(50, 100, 250, 500, 1000)
LDA20 <- LDASamp(n_samples = 20, p = 2, effect = 25)
StabLDA20 <- StabExp(n_tree = n_tree, data = LDA20, reps = 100, leafsize = 5)
```

```{r}
LDA40 <- LDASamp(n_samples = 40, p = 2, effect = 25)
StabLDA40 <- StabExp(n_tree = n_tree, data = LDA40, reps = 100, leafsize = 8)
```

```{r}
LDA40 <- LDASamp(n_samples = 80, p = 2, effect = 25)
StabLDA80 <- StabExp(n_tree = n_tree, data = LDA80, reps = 10, leafsize = 16)
```

```{r}
CS20 <- CheckerSamp(n = 20, n_clusts = 3)
StabCS40 <- StabExp(n_tree = n_tree, data = CS20, reps = 100, leafsize = 60)
```

```{r}
CS40 <- CheckerSamp(n = 40, n_clusts = 3)
StabCS40 <- StabExp(n_tree = n_tree, data = CS40, reps = 100, leafsize = 125)
```

